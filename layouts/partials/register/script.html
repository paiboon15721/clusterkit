<script
  type="text/javascript"
  src="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dependencies/JQL.min.js"
></script>
<script
  type="text/javascript"
  src="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dependencies/typeahead.bundle.js"
></script>
<link
  rel="stylesheet"
  href="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dist/jquery.Thailand.min.css"
/>
<script
  type="text/javascript"
  src="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dist/jquery.Thailand.min.js"
></script>
<script>
  var registerModal = $('#registerModal')
  var failModal = new Vue({
    el: '#failModal',
    delimiters: ['${', '}'],
    data: () => ({
      errors: [],
    }),
  })
  var register = new Vue({
    el: '#register',
    delimiters: ['${', '}'],
    data: () => ({
      loading: false,
      isValidated: false,
      openingClasses: [],
      courseID: '',
      subID: '',
      subName: '',
      nameEN: 'mock',
      surnameEN: 'mock',
      nameTH: 'mock',
      surnameTH: 'mock',
      address: 'mock',
      district: 'mock',
      amphoe: 'mock',
      province: 'mock',
      zipcode: '10150',
      tel: '02528324324',
      email: 'mock@mock.com',
      quotation: 'no',
      note: '',
      type: '1',
      companyNameEN: 'mock',
      companyNameTH: 'mock',
      branch: '',
      taxID: '213213123',
      companyAddress: 'mock',
      companyDistrict: 'mock',
      companyAmphoe: 'mock',
      companyProvince: 'mock',
      companyZipcode: 'mock',
    }),
    methods: {
      submit: function(e) {
        if (this.$refs.registerForm.checkValidity()) {
          this.loading = true
          var params = new URLSearchParams()
          params.append('courseID', this.courseID)
          params.append('nameEN', this.nameEN)
          params.append('surnameEN', this.surnameEN)
          params.append('nameTH', this.nameTH)
          params.append('surnameTH', this.surnameTH)
          params.append('address', this.address)
          params.append('district', this.district)
          params.append('amphoe', this.amphoe)
          params.append('province', this.province)
          params.append('zipcode', this.zipcode)
          params.append('tel', this.tel)
          params.append('email', this.email)
          params.append('quotation', this.quotation)
          params.append('note', this.note)
          params.append('type', this.type)
          if (this.type === '2') {
            params.append('companyNameEN', this.companyNameEN)
            params.append('companyNameTH', this.companyNameTH)
            params.append('branch', this.branch)
            params.append('taxID', this.taxID)
            params.append('companyAddress', this.companyAddress)
            params.append('companyDistrict', this.companyDistrict)
            params.append('companyAmphoe', this.companyAmphoe)
            params.append('companyProvince', this.companyProvince)
            params.append('companyZipcode', this.companyZipcode)
          }
          axios
            .post('http://www.clusterkit.co.th/api/register.php', params, {
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
            })
            .then(res => {
              this.loading = false
              registerModal.modal('hide')
              $('#successModal').modal('show')
              $('#debug').html(JSON.stringify(res.data, null, 2))
            })
            .catch(e => {
              this.loading = false
              $('#failModal').modal('show')
              failModal.errors = e.response.data
            })
        } else {
          this.$refs.registerForm.reportValidity()
        }
        this.isValidated = true
      },
    },
  })

  registerModal.on('show.bs.modal', function(e) {
    Object.assign(register.$data, register.$options.data())
    register.loading = true
    register.subID = $(e.relatedTarget).data('subid')
    register.subName = $(e.relatedTarget).data('subname')
    axios
      .get(
        'http://www.clusterkit.co.th/api/opening-classes.php?subID=' +
          register.subID,
      )
      .then(res => {
        register.openingClasses = res.data
        register.courseID = register.openingClasses[0].course_id
        register.loading = false
      })
  })

  $.Thailand({
    $district: $('#district'),
    $amphoe: $('#amphoe'),
    $province: $('#province'),
    $zipcode: $('#zipcode'),
    onDataFill: function(data) {
      register.district = data.district
      register.amphoe = data.amphoe
      register.province = data.province
      register.zipcode = data.zipcode
    },
  })

  $.Thailand({
    $district: $('#companyDistrict'),
    $amphoe: $('#companyAmphoe'),
    $province: $('#companyProvince'),
    $zipcode: $('#companyZipcode'),
    onDataFill: function(data) {
      register.companyDistrict = data.district
      register.companyAmphoe = data.amphoe
      register.companyProvince = data.province
      register.companyZipcode = data.zipcode
    },
  })
</script>
